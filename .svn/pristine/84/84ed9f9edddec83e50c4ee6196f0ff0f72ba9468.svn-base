<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.document.mapper.ProofMapper">

<!-- 의사) 제증명 발급 대기 목록 조회 
<select id="docuWaitPat" resultType="kr.or.ddit.document.vo.DocuWaitPatVO">
	SELECT 
	    TB_PATIENT.PAT_NAME,
	    TB_PATIENT.PAT_BRTHDY,
	    CASE 
	        WHEN SUBSTR(TB_REQUEST_OPINION.REQ_OPINION_NO, -3, 1) = '3' THEN '진단서'
	        WHEN SUBSTR(TB_REQUEST_OPINION.REQ_OPINION_NO, -3, 1) = '4' THEN '소견서'
	        ELSE '알 수 없음'
	    END AS DOC_TYPE,
	    TB_REQUEST_OPINION.REQ_OPINION_NO,
	    TB_REQUEST_OPINION.REQ_OPINION_REG_DATE,
	    TB_REQUEST_OPINION.REQ_OPINION_STATUS,
	    TB_REQUEST_OPINION.DETAIL_NO
	FROM 
	    TB_REQUEST_OPINION
	INNER JOIN 
	    TB_CHART_DETAIL ON TB_REQUEST_OPINION.DETAIL_NO = TB_CHART_DETAIL.DETAIL_NO
	INNER JOIN 
	    TB_CLINIC ON TB_CHART_DETAIL.TREAT_NO = TB_CLINIC.TREAT_NO
	INNER JOIN 
	    TB_RECEIPT ON TB_CLINIC.RCEPT_NO = TB_RECEIPT.RCEPT_NO
	INNER JOIN 
	    TB_PATIENT ON TB_RECEIPT.PAT_CODE = TB_PATIENT.PAT_CODE
	WHERE REQ_OPINION_STATUS = 'DCWT'
	UNION ALL
	SELECT 
	    TB_PATIENT.PAT_NAME,
	    TB_PATIENT.PAT_BRTHDY,
	    CASE 
	        WHEN SUBSTR(TB_REQUEST_DIAGNOSIS.REQ_DIAGNOSIS_NO, -3, 1) = '3' THEN '진단서'
	        WHEN SUBSTR(TB_REQUEST_DIAGNOSIS.REQ_DIAGNOSIS_NO, -3, 1) = '4' THEN '소견서'
	        ELSE '알 수 없음'
	    END AS DOC_TYPE,
	     TB_REQUEST_DIAGNOSIS.REQ_DIAGNOSIS_NO,
	    TB_REQUEST_DIAGNOSIS.REQ_DIAGNOSIS_REG_DATE,
	    TB_REQUEST_DIAGNOSIS.REQ_DIAGNOSIS_STATUS,
	    TB_REQUEST_DIAGNOSIS.DETAIL_NO
	FROM 
	    TB_REQUEST_DIAGNOSIS
	INNER JOIN 
	    TB_CHART_DETAIL ON TB_REQUEST_DIAGNOSIS.DETAIL_NO = TB_CHART_DETAIL.DETAIL_NO
	INNER JOIN 
	    TB_CLINIC ON TB_CHART_DETAIL.TREAT_NO = TB_CLINIC.TREAT_NO
	INNER JOIN 
	    TB_RECEIPT ON TB_CLINIC.RCEPT_NO = TB_RECEIPT.RCEPT_NO
	INNER JOIN 
	    TB_PATIENT ON TB_RECEIPT.PAT_CODE = TB_PATIENT.PAT_CODE
	WHERE REQ_DIAGNOSIS_STATUS = 'DCWT'
</select>-->

<!-- 의사) 제증명 발급 대기 목록 조회 -->
<select id="docuWaitPat" resultType="kr.or.ddit.document.vo.DocuWaitPatVO" parameterType="kr.or.ddit.document.vo.DocuWaitPatVO">
SELECT 
    TB_PATIENT.PAT_NAME,
    TB_PATIENT.PAT_BRTHDY,
    TB_REQUEST_DOCUMENT.DOCUMENT_TYPE,
    TB_REQUEST_DOCUMENT.REQ_DOCUMENT_NO,
    TO_CHAR(TB_REQUEST_DOCUMENT.REQ_DOCUMENT_REG_DATE, 'YYYY-MM-DD') AS REQ_DOCUMENT_REG_DATE,
    TB_REQUEST_DOCUMENT.REQ_DOCUMENT_STATUS,
    TB_REQUEST_DOCUMENT.DETAIL_NO,
    TB_EMPLOYEE.EMP_NM
FROM 
    TB_REQUEST_DOCUMENT
INNER JOIN 
    TB_CHART_DETAIL ON TB_REQUEST_DOCUMENT.DETAIL_NO = TB_CHART_DETAIL.DETAIL_NO
INNER JOIN 
    TB_CLINIC ON TB_CHART_DETAIL.TREAT_NO = TB_CLINIC.TREAT_NO
INNER JOIN 
    TB_RECEIPT ON TB_CLINIC.RCEPT_NO = TB_RECEIPT.RCEPT_NO
INNER JOIN 
    TB_CLINIC_SCHEDULE ON TB_CLINIC_SCHEDULE.SCHD_NO = TB_RECEIPT.SCHD_NO  
INNER JOIN 
    TB_EMPLOYEE ON TB_CLINIC_SCHEDULE.EMP_NO = TB_EMPLOYEE.EMP_NO  
INNER JOIN 
    TB_PATIENT ON TB_RECEIPT.PAT_CODE = TB_PATIENT.PAT_CODE
WHERE REQ_DOCUMENT_STATUS = 'DCWT' AND TB_CLINIC_SCHEDULE.EMP_NO = #{empNo}
</select>
</mapper>